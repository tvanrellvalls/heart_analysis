---
title: "PRA2"
author: "Toni Vanrell i Guillem Mir"
date: "31/5/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
````{r libraries, echo = FALSE, warning = FALSE, message = FALSE}
library(pROC)
library(corrplot)
library(HH)
library(dplyr)
library(tidyr)
````
## 1. Descripció
El subdataset escollit és un conegut dataset de Kaggle amb dades relacionades amb malalties cardíaques. Les variables que inclou el dataset són:

1. Edat: Edat de la persona.

2. Sexe: Sexe biològic de la persona.

3. Dolor al pit: Tipus de dolor al pit (Asimptòmatic, típic, atípic o sense dolor).

4. Pressió sanguínea: Pressió sanguínea en descans.

5. Colesterol: Concentració de colesterol en sang en mg/dl.

6. Sucre a la sang: Classificació segons diabètic o no diabètic.

7. Electrocardiograma: Anomalis en la lectura de l'electrocardiograma.

8. Freqüència cardíaca màxima.

9. Angina induïda: Presència d'angina de pit induïda per exercici.

10. Depressió del segment ST: Presència del segment ST en l'electrocardiograma.

11. Pendent del segment ST: Pendent del segment ST.

12. Número de vasos majors: Número de vasos colorejats durant la revisió per fluoroscòpia.

13. Talassèmia: Presència de la condició hereditària coneguda com Talassèmia.

14. Target: Presència o no de malaltia cardíaca.

Aquest dataset ens permet estudiar quins factors tenen influència directa sobre l'aparició de malalties coronàries. La intenció del nostre treball és visualitzar possibles relacions que puguin derivar en mesures preventives.

## 2.
Integració i selecció de les dades d'interès.

```{r integracio}
# Carreguem el fitxer "SFO.csv"
data <- read.csv('heart.csv')

colnames(data) <- c('age', 'sex', 'chestPain', 'bloodPressure',
                    'cholesterol', 'bloodSugar', 'restecg',
                    'maxHeartRate', 'indAngina', 'stDepression', 
                    'stSlope', 'numVessels', 'scintigraphy', 'target')
# Recodifiquem i seleccionem variables d'interés per la nostra anàlisi
data2 <- data %>% mutate(
  sex = if_else(sex == 1, "Male", "Female"),
  bloodSugar = ifelse(bloodSugar == 1, '> 120 mg/dl', '< 120 mg/dl'),
  chestPain = ifelse(chestPain == 1,'Typical Angina',
                     ifelse(chestPain == 2, 'Atypical Angina',
                            ifelse(chestPain == 3,'Non-Anginal Pain', 'Asymptomatic'))),
  indAngina = ifelse(indAngina == 0,'No','Yes'),
  target = if_else(target == 1, "YES", "NO")
) %>% mutate_if(is.character, as.factor)

data2 <- data2[,c(1:6,8,9,14)]
summary(data2)

```
Les variables d'interés seleccionades per aquest estudi han estat edat, sexe, dolor de pit, pressió sanguínea, colesterol, sucre a la sang, freqüència cardíaca màxima, angina induïda i, necessàriament, target (presència de dolència cardíaca).

Aquestes variables han estat escollides per adequació dels coneixements en el camp dels membres del grup i per la seva importància a priori com a indicatives de l'estat de salut.

## 3. Neteja de les dades.
### 3.1. Valors nuls
```{r valors nuls}
sapply(data2, function(x) sum(is.na(x)))
```

Com podem veure, no hi ha valors nuls. Tanmateix cal clarificar que si ens trobessim algun cas la millor estratègia hagués estat la seva imputació probabilística pel mètode del veí més proper. Aquest tipus d'estratègia seria l'idonea pel tipus de dades que manegem i per l'escassetat d'observacions.

### 3.2. Valors atípics.
````{r valors atípics}
boxplot(data2$age)
bpage <- quantile(data2$age, 0.75) - quantile(data2$age, 0.25)
sum(data2$age > median(data2$age)+3*bpage)
boxplot(data2$bloodPressure)
bprq <- quantile(data2$bloodPressure, 0.75) - quantile(data2$bloodPressure, 0.25)
sum(data2$bloodPressure > median(data2$bloodPressure)+3*bprq)
boxplot(data2$cholesterol)
chorq <- quantile(data2$cholesterol, 0.75) - quantile(data2$cholesterol, 0.25)
sum(data2$cholesterol > median(data2$cholesterol)+3*chorq)
boxplot(data2$maxHeartRate)
mhrrq <- quantile(data2$maxHeartRate, 0.75) - quantile(data2$maxHeartRate, 0.25)
sum(data2$maxHeartRate < median(data2$maxHeartRate)-3*mhrrq)
````
Com podem observar als boxplots i als recomptes de valors atípics veiem que existeixen valors anòmals per tres de les variables quantitatives i valors extremadament anòmals per dues d'elles. Tanmateix una investigació del comportament d'aquestes variables pel cas general podem afirmar que, si bé són valors llunyans del rang interquartílic, són valors perfectament possibles i que no és probable que es deguin a errors de mesura. Per tant, decidim mantenir-los en la nostra anàlisi.

````{r exportacio}
#### Exportació #####
heart <- data2
write.csv(heart,"heart_clean.csv")
````
Un cop realitzada la neteja i selecció de les dades, procedim a exportar el dataset definitiu. 

## 4. Anàlisi de les dades.
### 4.1. Planificació de l'anàlisi

L'anàlisi que realitzarem de les dades es dividirà en tres subapartats. Primerament analitzarem la correlació existent entre les variables quantitatives. Aquesta anàlisi la realitzarem per descobrir si existeix multicolinealitat entre les dades i conèixer millor la relació interna entre aquestes variables. Seguidament, realitzarem tests de chi-quadrat per evaluar la significació de la relació entre les variables categòriques i la variable dependent (target). Finalment, realitzarem una anàlisi de possibles regressions logístiques i evaluarem quin és el millor model explicatiu i predictiu per les dades. Tanmateix, prèviament analitzarem la normalitat i homogeneitat de les variables quantitatives.

### 4.2. Normalitat i Homogeneïtat
````{r normalitat}
# Shapiro-Wilks (Normalitat)
normtest <- data.frame(matrix(ncol = 2, nrow = 4))
colnames(normtest) <- c("Nom", "Pvalor")
normtest[1,1]<-"Edat"
normtest[2,1]<-"Pressió"
normtest[3,1]<-"Colesterol"
normtest[4,1]<-"Freqüència"
normtest[1,2]<-shapiro.test(heart$age)$p.value # No hi ha normalitat
normtest[2,2]<-shapiro.test(heart$bloodPressure)$p.value  # No hi ha normalitat
normtest[3,2]<-shapiro.test(heart$cholesterol)$p.value  # No hi ha normalitat
normtest[4,2]<-shapiro.test(heart$maxHeartRate)$p.value  # No hi ha normalitat
normtest
hist(heart$age)
hist(heart$bloodPressure)
hist(heart$cholesterol)
hist(heart$maxHeartRate)
````
Com podem veure pels resultats dels tests Shapiro-Wilks i corroborar per la forma dels histogrames, ninguna de les variables quantitatives presenta normalitat per les seves distribucions. El que comportarà aquesta situació és la utilització d'anàlisis no paramètrics.

````{r homogenïtat}
hov(heart$age ~ heart$target) # No hi ha homogeneïtat
hov(heart$bloodPressure ~ heart$target) # Hi ha homogeneïtat
hov(heart$cholesterol ~ heart$target) # Hi ha homogeneïtat
hov(heart$maxHeartRate ~ heart$target) # No hi ha homogeneïtat
````
Com veiem pel test Brown-Forsyth, adequat per distribucions no normals, només podem afirmar amb significació que existeix homogeneïtat per les variables pressió sanguínea i colesterol. Aquests resultats tindrà relevància en les decisions referents a l'anàlisi de correlacions.